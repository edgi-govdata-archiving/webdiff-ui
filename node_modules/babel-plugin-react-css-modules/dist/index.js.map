{"version":3,"sources":["../src/index.js"],"names":["t","types","filenameMap","setupFileForRuntimeResolution","path","filename","programPath","findParent","parentPath","isProgram","importedHelperIndentifier","scope","generateUidIdentifier","styleModuleImportMapIdentifier","unshiftContainer","importDeclaration","importDefaultSpecifier","stringLiteral","firstNonImportDeclarationNode","get","find","node","isImportDeclaration","insertBefore","variableDeclaration","variableDeclarator","styleModuleImportMap","addWebpackHotModuleAccept","test","memberExpression","identifier","consequent","blockStatement","expressionStatement","callExpression","source","value","functionExpression","hotAcceptStatement","ifStatement","inherits","visitor","ImportDeclaration","stats","opts","filetypes","extension","lastIndexOf","substr","Object","keys","indexOf","file","targetFileDirectoryPath","targetResourcePath","startsWith","require","resolve","styleImportName","specifiers","length","process","env","NODE_ENV","Math","random","local","name","console","warn","Error","context","generateScopedName","webpackHotModuleReloading","JSXElement","styleNameAttribute","openingElement","attributes","attribute","isStringLiteral","isJSXExpressionContainer","Program"],"mappings":"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","file":"index.js","sourcesContent":["// @flow\n\nimport {\n  dirname,\n  resolve\n} from 'path';\nimport babelPluginJsxSyntax from 'babel-plugin-syntax-jsx';\nimport BabelTypes from 'babel-types';\nimport createObjectExpression from './createObjectExpression';\nimport requireCssModule from './requireCssModule';\nimport resolveStringLiteral from './resolveStringLiteral';\nimport replaceJsxExpressionContainer from './replaceJsxExpressionContainer';\n\nexport default ({\n  types: t\n}: {\n  types: BabelTypes\n}) => {\n  const filenameMap = {};\n\n  const setupFileForRuntimeResolution = (path, filename) => {\n    const programPath = path.findParent((parentPath) => {\n      return parentPath.isProgram();\n    });\n\n    filenameMap[filename].importedHelperIndentifier = programPath.scope.generateUidIdentifier('getClassName');\n    filenameMap[filename].styleModuleImportMapIdentifier = programPath.scope.generateUidIdentifier('styleModuleImportMap');\n\n    programPath.unshiftContainer(\n      'body',\n      t.importDeclaration(\n        [\n          t.importDefaultSpecifier(\n            filenameMap[filename].importedHelperIndentifier\n          )\n        ],\n        t.stringLiteral('babel-plugin-react-css-modules/dist/browser/getClassName')\n      )\n    );\n\n    const firstNonImportDeclarationNode = programPath.get('body').find((node) => {\n      return !t.isImportDeclaration(node);\n    });\n\n    firstNonImportDeclarationNode.insertBefore(\n      t.variableDeclaration(\n        'const',\n        [\n          t.variableDeclarator(\n            filenameMap[filename].styleModuleImportMapIdentifier,\n            createObjectExpression(t, filenameMap[filename].styleModuleImportMap)\n          )\n        ]\n      )\n    );\n    // eslint-disable-next-line\n    // console.log('setting up', filename, util.inspect(filenameMap,{depth: 5}))\n  };\n\n  const addWebpackHotModuleAccept = (path) => {\n    const test = t.memberExpression(t.identifier('module'), t.identifier('hot'));\n    const consequent = t.blockStatement([\n      t.expressionStatement(\n        t.callExpression(\n          t.memberExpression(\n            t.memberExpression(t.identifier('module'), t.identifier('hot')),\n            t.identifier('accept')\n          ),\n          [\n            t.stringLiteral(path.node.source.value),\n            t.functionExpression(null, [], t.blockStatement([\n              t.expressionStatement(\n                t.callExpression(\n                  t.identifier('require'),\n                  [t.stringLiteral(path.node.source.value)]\n                )\n              )\n            ]))\n          ]\n        )\n      )\n    ]);\n\n    const programPath = path.findParent((parentPath) => {\n      return parentPath.isProgram();\n    });\n\n    const firstNonImportDeclarationNode = programPath.get('body').find((node) => {\n      return !t.isImportDeclaration(node);\n    });\n\n    const hotAcceptStatement = t.ifStatement(test, consequent);\n\n    firstNonImportDeclarationNode.insertBefore(hotAcceptStatement);\n  };\n\n  return {\n    inherits: babelPluginJsxSyntax,\n    visitor: {\n      ImportDeclaration (path: Object, stats: Object): void {\n        stats.opts.filetypes = stats.opts.filetypes || {};\n\n        const extension = path.node.source.value.lastIndexOf('.') > -1 ? path.node.source.value.substr(path.node.source.value.lastIndexOf('.')) : null;\n\n        if (extension !== '.css' && Object.keys(stats.opts.filetypes).indexOf(extension) < 0) {\n          return;\n        }\n\n        const filename = stats.file.opts.filename;\n        const targetFileDirectoryPath = dirname(stats.file.opts.filename);\n\n        const targetResourcePath = path.node.source.value.startsWith('.') ? resolve(targetFileDirectoryPath, path.node.source.value) : require.resolve(path.node.source.value);\n\n        let styleImportName: string;\n\n        if (path.node.specifiers.length === 0) {\n          // eslint-disable-next-line no-process-env\n          styleImportName = process.env.NODE_ENV === 'test' ? 'random-test' : 'random-' + Math.random();\n        } else if (path.node.specifiers.length === 1) {\n          styleImportName = path.node.specifiers[0].local.name;\n        } else {\n          // eslint-disable-next-line no-console\n          console.warn('Please report your use case. https://github.com/gajus/babel-plugin-react-css-modules/issues/new?title=Unexpected+use+case.');\n\n          throw new Error('Unexpected use case.');\n        }\n\n        filenameMap[filename].styleModuleImportMap[styleImportName] = requireCssModule(targetResourcePath, {\n          context: stats.opts.context,\n          filetypes: stats.opts.filetypes || {},\n          generateScopedName: stats.opts.generateScopedName\n        });\n\n        if (stats.opts.webpackHotModuleReloading) {\n          addWebpackHotModuleAccept(path);\n        }\n      },\n      JSXElement (path: Object, stats: Object): void {\n        const filename = stats.file.opts.filename;\n        const styleNameAttribute = path.node.openingElement.attributes\n          .find((attribute) => {\n            return typeof attribute.name !== 'undefined' && attribute.name.name === 'styleName';\n          });\n\n        if (!styleNameAttribute) {\n          return;\n        }\n\n        if (t.isStringLiteral(styleNameAttribute.value)) {\n          resolveStringLiteral(\n            path,\n            filenameMap[filename].styleModuleImportMap,\n            styleNameAttribute\n          );\n\n          return;\n        }\n\n        if (t.isJSXExpressionContainer(styleNameAttribute.value)) {\n          if (!filenameMap[filename].importedHelperIndentifier) {\n            setupFileForRuntimeResolution(path, filename);\n          }\n          replaceJsxExpressionContainer(\n            t,\n            path,\n            styleNameAttribute,\n            filenameMap[filename].importedHelperIndentifier,\n            filenameMap[filename].styleModuleImportMapIdentifier\n          );\n        }\n      },\n      Program (path: Object, stats: Object): void {\n        const filename = stats.file.opts.filename;\n\n        filenameMap[filename] = {\n          styleModuleImportMap: {}\n        };\n      }\n    }\n  };\n};\n"]}